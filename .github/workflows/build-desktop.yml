# GitHub Actions Workflow for Building Songbase Desktop Application
# Builds cross-platform Electron apps for macOS, Windows, and Linux

name: Build Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        type: string

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # Build Backend Binary
  # =============================================================================
  build-backend:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin
            arch: arm64
          - os: macos-13
            platform: darwin
            arch: x64
          - os: ubuntu-22.04
            platform: linux
            arch: x64
          - os: windows-2022
            platform: win32
            arch: x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ffmpeg libsndfile

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ffmpeg -y

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build backend binary
        run: |
          pyinstaller --clean --noconfirm songbase-api.spec

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/songbase-api/
          retention-days: 7

  # =============================================================================
  # Build Frontend
  # =============================================================================
  build-frontend:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend for Electron
        working-directory: frontend
        run: npm run build
        env:
          BUILD_TARGET: electron

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/out/
          retention-days: 7

  # =============================================================================
  # Package Electron App
  # =============================================================================
  package-electron:
    needs: [build-backend, build-frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: mac
            backend-platform: darwin
            backend-arch: arm64
          - os: macos-13
            platform: mac
            backend-platform: darwin
            backend-arch: x64
          - os: ubuntu-22.04
            platform: linux
            backend-platform: linux
            backend-arch: x64
          - os: windows-2022
            platform: win
            backend-platform: win32
            backend-arch: x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.backend-platform }}-${{ matrix.backend-arch }}
          path: dist/songbase-api/

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/out/

      - name: Install Electron dependencies
        run: npm ci

      - name: Make backend binary executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x dist/songbase-api/songbase-api

      # macOS Code Signing
      - name: Import code signing certificate (macOS)
        if: runner.os == 'macOS' && env.CSC_LINK != ''
        env:
          CSC_LINK: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          echo "$CSC_LINK" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          rm certificate.p12

      # Windows Code Signing
      - name: Import code signing certificate (Windows)
        if: runner.os == 'Windows' && env.CSC_LINK != ''
        env:
          CSC_LINK: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          echo "$env:CSC_LINK" | Out-File -Encoding ascii certificate.b64
          certutil -decode certificate.b64 certificate.pfx
          Remove-Item certificate.b64

      - name: Build Electron app
        run: npx electron-builder --${{ matrix.platform }} --config electron-builder.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS notarization
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Code signing
          CSC_LINK: ${{ runner.os == 'macOS' && secrets.MACOS_CERTIFICATE_BASE64 || secrets.WINDOWS_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ runner.os == 'macOS' && secrets.MACOS_CERTIFICATE_PASSWORD || secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: songbase-${{ matrix.platform }}-${{ matrix.backend-arch }}
          path: |
            dist-electron/*.dmg
            dist-electron/*.zip
            dist-electron/*.exe
            dist-electron/*.AppImage
            dist-electron/*.deb
            dist-electron/*.rpm
          retention-days: 30

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  release:
    needs: package-electron
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: songbase-*

      - name: Organize release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: true
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
